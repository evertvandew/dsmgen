<!doctype html>
<html>

<head>
<meta charset="utf-8">
<script type="text/javascript" src="brython.js"></script>
<script type="text/javascript" src="brython_stdlib.js"></script>
</head>

<body onload="brython(1)">
    <button id="NormalEditBtn">Normal</button><button id="EditConnectionsBtn">Connect</button>
    <svg id="canvas" width="100%" height="500px"
        style="border-color:#000;border-style:solid;border-width:1px;margin-left:0px;">
          <defs>
            <marker id="startarrow" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
              <polygon points="10 0, 10 7, 0 3.5" fill="black" />
            </marker>
            <marker id="endarrow" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" markerUnits="strokeWidth">
                <polygon points="0 0, 10 3.5, 0 7" fill="black" />
            </marker>
            <marker id="startarrow" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
              <polygon points="10 0, 10 7, 0 3.5" fill="black" />
            </marker>
            <marker id="endarrow" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" markerUnits="strokeWidth">
                <polygon points="0 0, 10 3.5, 0 7" fill="black" />
            </marker>
         </defs>
    </svg>

    <div style="float:left; width=40%;"><h1>Properties</h1><div id="properties" /></div>
    </div>

    <script type="text/python">
        from browser import document, console, html
        import diagrams
        from dataclasses import fields
        import traceback
        from typing import Hashable
        import json

        diagrams.createDiagram("canvas", "properties");

        type2HtmlInput = {
                float: {'type': 'number', 'step': 'any'},
                str: {'type': 'text'},
                int: {'type': 'number', 'step': 1}
            }


        # Add the logic to edit parameters
        # When a block is selected, the canvas throws an event with the details
        def onBlockSelected(ev):
            # Clear any remnants of a previous properties editor
            properties_div = document['properties']
            for e in properties_div.children:
                e.remove()
            # Use the annotations to create the properties editor
            form = html.FORM()
            o = ev.detail.object

            editable_fields = [f for f in fields(o) if f.name not in ['x', 'y', 'height', 'width'] and isinstance(f.type, Hashable) and f.type in type2HtmlInput]

            for field in editable_fields:
                label = html.LABEL(field.name)
                label.className ="col-sm-3 col-form-label"
                ip = html.INPUT(id=f"edit_{field.name}", name=field.name, value=getattr(o, field.name), **type2HtmlInput[field.type])
                ip.className = 'form-control'
                form <= label
                form <= ip
                form <= html.BR()

            port_fields = [f for f in fields(o) if type(field.type) == list and all(issubclass(t, diagrams.CP) for t in field.type)]

            properties_div <= form

            # Add a SAVE button
            def onSave(_):
                # Because this is a Closure, we can use the captured variables
                # Get the new values for the editable fields
                update = {}
                for field in editable_fields:
                    # Use the standard constructor for the type to do the conversion
                    update[field.name] = field.type(document[f'edit_{field.name}'].value)
                ev.detail.update(json.dumps(update))

            b = html.BUTTON("Save", type="button")
            b.className = "btn btn-primary"
            b.bind("click", onSave)
            properties_div <= b

        canvas = document['canvas']
        canvas.bind('shape_selected', onBlockSelected)
    </script>

</body>

</html>