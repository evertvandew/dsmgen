
from browser import html, console, bind, document
from browser.widgets.dialog import Dialog, EntryDialog, InfoDialog

from typing import List, Dict, Any

from property_editor import dataClassEditorForm, getFormValues

line_cls = 'eline'


class Element: pass


context_menu_name = 'ContextMenu'


class ExplorerDataApi:
    """ Api that the explorer works with to manage its contents """
    def get_allowed_children(self, id: str) -> List[Element]:
        """ Determine which children can be contained by an element.
            Used to create the right-click menu
        """
        raise NotImplementedError
    def get_elements_async(self, cb):
        """ Retrieve a list of elements.
            Some of these elements can have children, representing a hierarchy
        """
        raise NotImplementedError
    def get_element(self, id: str) -> Element:
        raise NotImplementedError
    def add_element(self, details: Element, parent: str):
        """ Persist a new element created with the right-click menu """
        raise NotImplementedError
    def move_element(self, id: str):
        """ Called when an element is moved in the hierarchy. """
        raise NotImplementedError
    def delete_element(self, id: str) -> bool:
        """ Called when an element is deleted.
            Returns True if the delete was successful, false if not.
        """
        raise NotImplementedError
    def on_click(self, id: str):
        """ Called when an element was left-clicked. """
        raise NotImplementedError


def toggle_caret(ev):
    ev.stopPropagation()
    ev.preventDefault()
    c = ev.target
    holder = c.parent.parent
    children = [c for c in holder.child_nodes if line_cls in c.classList]
    if 'fa-caret-right' in c.classList:
        c.classList.remove('fa-caret-right')
        c.classList.add('fa-caret-down')
        for child in children:
            child.style['display'] = 'block'
    else:
        c.classList.add('fa-caret-right')
        c.classList.remove('fa-caret-down')
        for child in children:
            child.style['display'] = 'none'



def make_explorer(holder, api: ExplorerDataApi):
    def bind_events(data_element, html_element):
        @bind(html_element, 'click')
        def clickfunc(ev):
            api.on_click(data_element.id)
            ev.stopPropagation()
            ev.preventDefault()

        def on_delete(element):
            pass

        def on_rename(element):
            pass

        def on_add(ev, etype, parent):
            ev.stopPropagation()
            ev.preventDefault()
            console.log(f'Adding {etype.__name__} for {parent}')
            document[context_menu_name].close()
            d = Dialog(f'Add {etype.__name__}', ok_cancel=True)
            d.panel <= dataClassEditorForm(None, etype)

            def on_ok(ev):
                data = getFormValues(d.panel, etype)
                new_object = etype(**data)
                api.add_element(new_object, parent)
                document[parent] <= render_hierarchy([new_object])
                d.close()

            d.ok_button.bind('click', on_ok)

        def mk_menu_item(text, action):
            item = html.LI(text)
            item.bind('click', action)
            return item

        def bind_add_action(item):
            return mk_menu_item(item.__name__, lambda ev: on_add(ev, item, data_element.id))

        @bind(html_element, 'contextmenu')
        def contextfunc(ev):
            create = api.get_allowed_children(data_element.id)
            ev.stopPropagation()
            ev.preventDefault()
            createmenu = html.LI('Create')
            createmenu <= html.UL([bind_add_action(t) for t in create])
            menu = html.UL(Class='contextmenu')
            menu <= createmenu
            menu <= html.HR()
            menu <= mk_menu_item('Rename', on_rename)
            menu <= html.HR()
            menu <= mk_menu_item('Remove', on_delete)
            #d = Dialog("", ok_cancel=True)
            d = document[context_menu_name]
            d.clear()
            d <= menu
            html_element <= d
            d.showModal()

        for c in html_element.select('.caret'):
            c.bind('click', toggle_caret)

    def render_hierarchy(data_list):
        results = []
        for element in data_list:
            # Check if the caret is needed
            de = html.DIV()
            if (children := getattr(element, 'children', None)) is not None:
                de <= html.SPAN(Class="caret fa fa-caret-right", style="width:1em")
                de <= html.SPAN(Class="fa fa-folder")
            else:
                de <= html.SPAN(Class="fa fa-file", style="margin-left:1em")
            de <= html.SPAN(f' &mdash; {element.name}')

            d = html.DIV(de, Class=line_cls, id=element.id)
            d.value = element

            bind_events(element, d)

            if children:
                ch = render_hierarchy(element.children)
                for c in ch:
                    c.style['display'] = 'none'
                d <= ch
            results.append(d)
        return results

    def start(elements):
        holder <= render_hierarchy(elements)

    api.get_elements_async(start)

